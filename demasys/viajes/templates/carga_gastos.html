{% extends 'base.html' %}
{% load i18n %}
{% load i18n humanize %}
{% load sepomex_filters %}
{% load url from future %}

{% block title %}Viajes{% endblock %}
{% block content_title %} Carga de Historico {% endblock %}

{% block extra_head %}
<link rel="stylesheet" type="text/css" href="{{MEDIA_URL}}plugins/bootstrap-datepicker/css/datepicker3.css"/>
<link rel="stylesheet" type="text/css" href="{{MEDIA_URL}}plugins/select2/select2.css"/>
{% endblock %}

{% block nav-viajes %}<li class="active">{% endblock %}

{% block breadcrumb %}
<ul class="page-breadcrumb">
	<li>
		<i class="fa fa-home"></i>
		<a href="{% url 'dashboards.views.index' %}">Dashboard</a>	
		<i class="fa fa-angle-right"></i>					
	</li>
	<li>		
		<a href="{% url 'viajes.views.index' %}">Viajes</a>		
		<i class="fa fa-angle-right"></i>				
	</li>	
	<li>		
		<a href="#">Carga de Historico </a>							
	</li>	
</ul>
{% endblock %}

{% block actions %}
{% endblock %}

{% block content %}	
<form class="form-horizontal form-row-seperated" role="form" action="" method="post" id="statusform" enctype="multipart/form-data">
	{% csrf_token %}
	{{ formset_salida.management_form }}
	{{ formset_regreso.management_form }}
	{{ formset_entregado.management_form}}
	
	<div class="row">
		<div class="col-md-12">
			<div class="portlet-body form">					
				<div class="form-body">							
					<h3 class="form-section">Datos Generales</h3>
					<div class="row">
						<div class="col-md-6">
							<div class="form-group {% if form.id.errors %}has-error{% endif %}">
								<label class="control-label col-md-3">Carta porte:</label>
								<div class="col-md-9">
									{{form.id}}
									{% if form.id.errors %}<span class="help-block">{{form.id.errors}}</span>{% endif %}
								</div>
							</div>
						</div>
						<!--/span-->
						<div class="col-md-6">
							<div class="form-group {% if form.fecha_salida.errors %}has-error{% endif %}">
								<label class="control-label col-md-3">Fecha de salida:<span class="required" aria-required="true"> * </span></label>
								<div class="col-md-9">
									<div class="input-group date date-picker" data-date-format="dd-mm-yyyy">
										{{form.fecha_salida}}	
										<span class="input-group-btn">
											<button class="btn blue" type="button">
												<i class="fa fa-calendar"></i>																	
											</button>				
										</span>		
									</div>
									{% if form.fecha_salida.errors %}<span class="help-block">{{form.fecha_salida.errors}}</span>{% endif %}										
								</div>
							</div>
						</div>
						<!--/span-->
					</div>
					<div class="row">
						<div class="col-md-6">
							<div class="form-group {% if form.cliente.errors %}has-error{% endif %}">
								<label class="control-label col-md-3">Cliente:</label>
								<div class="col-md-9">
									{{form.cliente}}
									{% if form.cliente.errors %}<span class="help-block">{{form.cliente.errors}}</span>{% endif %}
								</div>
							</div>
						</div>
						<!--/span-->
						<div class="col-md-6">
							<div class="form-group {% if form.departamento.errors %}has-error{% endif %}">
								<label class="control-label col-md-3">Departamento:</label>
								<div class="col-md-9">											
									{{form.departamento}}
									{% if form.departamento.errors %}<span class="help-block">{{form.departamento.errors}}</span>{% endif %}
								</div>
							</div>
						</div>
						<!--/span-->
					</div>
					<div class="row">
						<div class="col-md-6">
							<div class="form-group {% if form.referencia.errors %}has-error{% endif %}">
								<label class="control-label col-md-3">Bill/Load:</label>
								<div class="col-md-9">
									{{form.referencia}}
									{% if form.referencia.errors %}<span class="help-block">{{form.referencia.errors}}</span>{% endif %}
								</div>
							</div>
						</div>
						<!--/span-->
						<div class="col-md-6">
							<div class="form-group {% if form.operador.errors %}has-error{% endif %}">
								<label class="control-label col-md-3">Operador:</label>
								<div class="col-md-9">
									{{form.operador}}
									{% if form.operador.errors %}<span class="help-block">{{form.operador.errors}}</span>{% endif %}
								</div>
							</div>
						</div>
						<!--/span-->
					</div>
					<div class="row">
						<div class="col-md-6">
							<div class="form-group {% if form.economico.errors %}has-error{% endif %}">
								<label class="control-label col-md-3">Economico:</label>
								<div class="col-md-9">
									{{form.economico}}
									{% if form.economico.errors %}<span class="help-block">{{form.economico.errors}}</span>{% endif %}
								</div>
							</div>
						</div>
						<!--/span-->
						<div class="col-md-6">
							<div class="form-group {% if form.tipo_ruta.errors %}has-error{% endif %}">
								<label class="control-label col-md-3">Tipo de ruta:</label>
								<div class="col-md-9">
									{{form.tipo_ruta}}
									{% if form.tipo_ruta.errors %}<span class="help-block">{{form.tipo_ruta.errors}}</span>{% endif %}
								</div>
							</div>
						</div>
						<!--/span-->
					</div>
					<div class="row">
						<div class="col-md-6">
							<div class="form-group {% if form.contiene.errors %}has-error{% endif %}">
								<label class="control-label col-md-3">Contenido:</label>
								<div class="col-md-9">										
									{{form.contiene}}
									{% if form.contiene.errors %}<span class="help-block">{{form.contiene.errors}}</span>{% endif %}
								</div>
							</div>
						</div>
						<div class="col-md-6">
							<div class="form-group {% if form.ruta.errors %}has-error{% endif %}">
								<label class="control-label col-md-3">Ruta:</label>
								<div class="col-md-9">
									{{form.ruta}}
									{% if form.ruta.errors %}<span class="help-block">{{form.ruta.errors}}</span>{% endif %}
								</div>
							</div>
						</div>
					</div>

								<h3>Datos de Destino</h3>													
												<div class="form-group {% if form.destinos.errors %}has-error{% endif %}">
													<label class="control-label col-md-3">Destino(s)<span class="required" aria-required="true"> * </span></label>
													<div class="col-md-9">
														{{form.destinos}}
														{% if form.destinos.errors %}<span class="help-block">{{form.destinos.errors}}</span>{% endif %}													
													</div>
												</div>
									<div class="form-group {% if form.destinos.errors %}has-error{% endif %}">
										<label class="control-label col-md-3">Destino(s) Actual(es):</label>
											<ul class="list-inline">
											{% for destino in viaje.destino_set.all %}
												<li>{{destino.destino_clave_municipio|municipio}}</li><br/>
											{% endfor %}
											</ul>
									</div>	

					<h3 class="form-section">Origenes</h3>
					<div class="row">
						<div class="col-md-6">
							<div class="form-group {% if form.origen_clave_municipio.errors %}has-error{% endif %}">
								<label class="control-label col-md-3">Municipio:</label>
								<div class="col-md-9">											
									{{form.origen_clave_municipio}}
									{% if form.origen_clave_municipio.errors %}<span class="help-block">{{form.origen_clave_municipio.errors}}</span>{% endif %}
								</div>
							</div>
						</div>
						<!--/span-->
						<div class="col-md-6">
							<div class="form-group {% if form.origen_colonia.errors %}has-error{% endif %}">
								<label class="control-label col-md-3">Colonia:</label>
								<div class="col-md-9">											
									{{form.origen_colonia}}
									{% if form.origen_colonia.errors %}<span class="help-block">{{form.origen_colonia.errors}}</span>{% endif %}
								</div>
							</div>
						</div>
						<!--/span-->
					</div>
					<div class="row">
						<div class="col-md-6">
							<div class="form-group {% if form.origen_calle.errors %}has-error{% endif %}">
								<label class="control-label col-md-3">Calle:</label>
								<div class="col-md-4">
									{{form.origen_calle}}
									{% if form.origen_calle.errors %}<span class="help-block">{{form.origen_calle.errors}}</span>{% endif %}
								</div>
								<label class="control-label col-md-2">Número<span class="required" aria-required="true"> * </span></label>
								<div class="col-md-3">
									{{form.origen_numero}}
									{% if form.origen_numero.errors %}<span class="help-block">{{form.origen_numero.errors}}</span>{% endif %}
								</div>
							</div>
						</div>
						<!--/span-->
						<div class="col-md-6">									
							<div class="form-group {% if form.origen_cp.errors %}has-error{% endif %}">
								<label class="control-label col-md-3">CP:</label>
								<div class="col-md-9">											
									{{form.origen_cp}}
									{% if form.origen_cp.errors %}<span class="help-block">{{form.origen_cp.errors}}</span>{% endif %}
								</div>
							</div>
							<div class="form-group last">
								<label class="control-label col-md-3"></label>
								<div class="col-md-4">
									<a class="btn blue" href="#" id="copyaddress">
										Usar dirección del cliente <i class="fa fa-share"></i>
									</a>
								</div>
							</div>
						</div>
						<div class="col-md-6">
							<div class="form-group {% if form.fecha_salida.errors %}has-error{% endif %}">
								<label class="control-label col-md-3">Fecha Entrega Mercancia:<span class="required" aria-required="true"> * </span></label>
								<div class="col-md-9">
									<div class="input-group date date-picker" data-date-format="dd/mm/yyyy">
										{{form.fecha_entmcia}}	
										<span class="input-group-btn">
											<button class="btn blue" type="button">
												<i class="fa fa-calendar"></i>
											</button>				
										</span>		
									</div>
																			
								</div>
							</div>
						</div>
					<div class="row">
						<div class="col-md-6">
							<div class="form-group {% if form.contiene.errors %}has-error{% endif %}">
								<label class="control-label col-md-3">Evidencia:</label>
								<div class="col-md-9">										
									{{form.evidencia}}
									{% if form.evidencia.errors %}<span class="help-block">{{form.evidencia.errors}}</span>{% endif %}
								</div>
							</div>
						</div>
						</div>

							

					<div class="col-md-6">
							<div class="form-group {% if form.fecha_salida.errors %}has-error{% endif %}">
								<label class="control-label col-md-3">Fecha de Entrega (Cerrar Viaje):<span class="required" aria-required="true"> * </span></label>
								<div class="col-md-9">
									<div class="input-group date date-picker" data-date-format="dd/mm/yyyy">
									<!--{{destino.fecha_entrega}}-->
										{{form.fecha_ent}}	
										<span class="input-group-btn">
											<button class="btn blue" type="button">
												<i class="fa fa-calendar"></i>			
											</button>				
										</span>		
									</div>
																			
								</div>
							</div>
						</div>
						
							<div class="row">
						<div class="col-md-6">
							<div class="form-group {% if form.contiene.errors %}has-error{% endif %}">
								<label class="control-label col-md-3"></label>
								<div class="col-md-9">										
									{{destino.id}}
									{% if destino.id.errors %}<span class="help-block">{{destino.id.errors}}</span>{% endif %}
								</div>
							</div>
						</div>
						</div>
						<div class="row">
						<div class="col-md-6">
							<div class="form-group {% if form.contiene.errors %}has-error{% endif %}">
								<label class="control-label col-md-3"></label>
								<div class="col-md-9">										
									{{destino.destino_clave_municipio}}
									{% if destino.destino_clave_municipio.errors %}<span class="help-block">{{destino.destino_clave_municipio.errors}}</span>{% endif %}
								</div>
							</div>
						</div>
						</div>		
					
						<!--/span-->
					</div>													
					<h3 class="form-section">Observaciones</h3>
					<div class="row">																				
						<div class="form-group {% if form.observaciones.errors %}has-error{% endif %}">
							<label class="control-label col-md-3">&nbsp;</label>
							<div class="col-md-9">
								{{form.observaciones}}																			
							</div>
						</div>
					</div>								
					<h3 class="form-section">Facturación</h3>	
					<div class="row">
						<div class="col-md-6">
							<div class="form-group">
								<label class="control-label col-md-3">No. de Factura:</label>
								<div class="col-md-9">											
									{{form.factura}}
									{% if form.factura.errors %}<span class="help-block">{{form.factura.errors}}</span>{% endif %}											
								</div>
							</div>
						</div>
						<!--/span-->
						<div class="col-md-6">
							<div class="form-group">
								<label class="control-label col-md-3">Forma de pago:</label>
								<div class="col-md-9">											
									{{form.facturacion_forma_pago}}
									{% if form.facturacion_forma_pago.errors %}<span class="help-block">{{form.facturacion_forma_pago.errors}}</span>{% endif %}											
								</div>
							</div>
						</div>
						<!--/span-->
					</div>	
					<div class="row">
						<div class="col-md-6">
							<div class="form-group">
								<label class="control-label col-md-3">Banco:</label>
								<div class="col-md-9">											
									{{form.facturacion_banco}}
									{% if form.facturacion_banco.errors %}<span class="help-block">{{form.facturacion_banco.errors}}</span>{% endif %}											
								</div>
							</div>
						</div>
						<!--/span-->
						<div class="col-md-6">
							<div class="form-group">
								<label class="control-label col-md-3">Documento:</label>
								<div class="col-md-9">											
									{{form.facturacion_documento}}
									{% if form.facturacion_documento.errors %}<span class="help-block">{{form.facturacion_documento.errors}}</span>{% endif %}											
								</div>
							</div>
						</div>
						<!--/span-->
					</div>	
					<div class="row">
						<div class="col-md-6">
							<div class="form-group">
								<label class="control-label col-md-3">Flete: </label>
								<div class="col-md-9">											
									{{form.facturacion_flete}}
									{% if form.facturacion_flete.errors %}<span class="help-block">{{form.facturacion_flete.errors}}</span>{% endif %}											
								</div>
							</div>
						</div>
						<!--/span-->
						<div class="col-md-6">
							<div class="form-group">
								<label class="control-label col-md-3">Casetas:</label>
								<div class="col-md-9">
									{{form.facturacion_casetas}}
									{% if form.facturacion_casetas.errors %}<span class="help-block">{{form.facturacion_casetas.errors}}</span>{% endif %}
								</div>
							</div>
						</div>
						<!--/span-->
					</div>	
					<div class="row">
						<div class="col-md-6">
							<div class="form-group">
								<label class="control-label col-md-3">Maniobra:</label>
								<div class="col-md-9">
									{{form.facturacion_maniobra}}
									{% if form.facturacion_maniobra.errors %}<span class="help-block">{{form.facturacion_maniobra.errors}}</span>{% endif %}
								</div>
							</div>									
						</div>
						<!--/span-->
						<div class="col-md-6">
							<div class="form-group">
								<label class="control-label col-md-3">Reparto: </label>
								<div class="col-md-9">											
									{{form.facturacion_reparto}}
									{% if form.facturacion_reparto.errors %}<span class="help-block">{{form.facturacion_reparto.errors}}</span>{% endif %}											
								</div>
							</div>									
						</div>
						<!--/span-->
					</div>
					<div class="row">
						<div class="col-md-6">
							<div class="form-group">
								<label class="control-label col-md-3">Desvio:</label>
								<div class="col-md-9">
									{{form.facturacion_desvio}}
									{% if form.facturacion_desvio.errors %}<span class="help-block">{{form.facturacion_desvio.errors}}</span>{% endif %}
								</div>
							</div>									
						</div>
						<!--/span-->
						<div class="col-md-6">
							<div class="form-group">
								<label class="control-label col-md-3">Ferri: </label>
								<div class="col-md-9">											
									{{form.facturacion_ferri}}
									{% if form.facturacion_ferri.errors %}<span class="help-block">{{form.facturacion_ferri.errors}}</span>{% endif %}											
								</div>
							</div>									
						</div>
						<!--/span-->
					</div>	
					<div class="row">
						<div class="col-md-6">
							<div class="form-group">
								<label class="control-label col-md-3">Otros:</label>
								<div class="col-md-9">
									{{form.facturacion_otros}}
									{% if form.facturacion_otros.errors %}<span class="help-block">{{form.facturacion_otros.errors}}</span>{% endif %}
								</div>
							</div>									
						</div>
						<!--/span-->
						<div class="col-md-6">
							<div class="form-group">
								<label class="control-label col-md-3"></label>
								<div class="col-md-9">											

								</div>
							</div>
						</div>								
						<!--/span-->
					</div>	
					<div class="row">
						<div class="col-md-6">
							<div class="form-group">
								<label class="control-label col-md-3">Subtotal: </label>
								<div class="col-md-9">											
									<p class="form-control-static">
										<span id="subtotal"></span>
									</p>											
								</div>
							</div>
						</div>
						<div class="col-md-6">
							<div class="form-group">
								<label class="control-label col-md-3"></label>
								<div class="col-md-9">											

								</div>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-md-6">
							<div class="form-group">
								<label class="control-label col-md-3">IVA:</label>
								<div class="col-md-9">
									<p class="form-control-static">
										<span id="iva"></span>
									</p>
								</div>
							</div>
						</div>
						<!--/span-->
						<div class="col-md-6">
							<div class="form-group">
								<label class="control-label col-md-3"></label>
								<div class="col-md-9">											

								</div>
							</div>
						</div>								
						<!--/span-->
					</div>	
					<div class="row">
						<div class="col-md-6">
							<div class="form-group">
								<label class="control-label col-md-3">Retención:</label>
								<div class="col-md-9">
									<p class="form-control-static">
										<span id="retencion"></span>
									</p>
								</div>
							</div>
						</div>
						<!--/span-->
						<div class="col-md-6">
							<div class="form-group">
								<label class="control-label col-md-3"></label>
								<div class="col-md-9">											

								</div>
							</div>
						</div>								
						<!--/span-->
					</div>		
					<div class="row">								
						<div class="col-md-6">
							<div class="form-group">
								<label class="control-label col-md-3">Total: </label>
								<div class="col-md-9">											
									<p class="form-control-static">
										<span id="total"></span>
									</p>											
								</div>
							</div>
						</div>
						<!--/span-->
						<div class="col-md-6">
							<div class="form-group">
								<label class="control-label col-md-3">&nbsp;</label>
								<div class="col-md-9">
									&nbsp;
								</div>
							</div>
						</div>
						<!--/span-->
					</div>
				</div>
			</div>
		</div>	
	</div>

<!-- /////////////////////////////////////////////////////////////////////////////-->

	<div class="portlet box grey-cascade">
	<div style=" text-align:center; font-size: 20px; font-family: 'Open Sans',sans-serif; color:white;">
										<div class="portlet-title">
											<div class="caption" >
								Saldos
							</div>							
						</div>
						</div>
						


<div class="table-responsive">		
							<table class="table table-striped table-hover table-bordered" id="regreso_table">
								<thead>
									<tr>
										<th style=" text-align:center;">
										Efectivo Contabilidad
										</th>
										<th style=" text-align:center;">
										Vales Contabilidad
										</th>
										<th style=" text-align:center;">
										Transferencia Contabilidad
										</th>
										<th style=" text-align:center;">
										Efectivo Operaciones 
										</th>
										<th style=" text-align:center;">
										Vales Operaciones
										</th>
										<th style=" text-align:center;">
										Transferencia Operaciones
										</th>
									</tr>
								</thead>
								<tbody>
									<tr class="tr_form_ap">
										<td style=" text-align:center;">
											{{saldoEfectivo}}
										</td>
										<td style=" text-align:center;">
											{{saldoVale}}
										</td>
										<td style=" text-align:center;">
											{{saldoTransferencia}}
										</td>
										<td style=" text-align:center;">
											{{saldoEO}}
										</td>
										<td style=" text-align:center;">
											{{saldoVO}}
										</td>
										<td style=" text-align:center;">
											{{saldoTO}}
										</td>
										</tr>						
									</tbody>
								</table>
							</div>

 </div>

 
<!-- /////////////////////////////////////////////////////////////////////////////-->




		<div class="row">		
			<div class="col-md-12">
				<div class="portlet light form-fit">				
					<div class="portlet-body form">					
						<h3 class="form-section">Gastos de Regresos</h3>

						<div class="table-responsive">		
							<table class="table table-striped table-hover table-bordered" id="regreso_table">
								<thead>
									<tr>
										<th>
											Concepto
										</th>
										<th>
											Comentarios
										</th>
										<th>
											Monto
										</th>
										<th>
											Forma de Pago 
										</th>
										<th>
											Movimiento realizado por
										</th>

										<th>
											Borrar
										</th>
									</tr>
								</thead>
								<tbody>
									{% for form in formset_regreso %}
									<tr class="tr_form_ap">
										<td>
											{{ form.id }}
											{{ form.concepto }}
											{% if form.concepto.errors %}<span class="help-block">{{form.concepto.errors}}</span>{% endif %}
										</td>
										<td>
											{{ form.comentarios }}
											{% if form.comentarios.errors %}<span class="help-block">{{form.comentarios.errors}}</span>{% endif %}
										</td>
										<td class="text-right">
											{{form.importe}}
											{% if form.importe.errors %}<span class="help-block">{{form.importe.errors}}</span>{% endif %}
										</td>
										<td style=" text-align:left;">
											{{ form.idPartida }}
											{% if form.idPartida.errors %}<span class="help-block">{{form.concepto.errors}}</span>{% endif %}
										</td>

										<td style=" text-align:left;">
											{{ form.idArea }}
											{% if form.idArea.errors %}<span class="help-block">{{form.idArea.errors}}</span>{% endif %}
										</td>


										<td>
											Borrar
											<a class="delete" href="javascript:;">
												{{ form.DELETE }}
												 </a>
											</td>
										</tr>	
										{% endfor %}							
									</tbody>
								</table>
							</div>

								


							</div>
						</div>
					</div>
				</div>
				<div class="form-actions">
					<div class="row">
						<div class="col-md-offset-3 col-md-9">
							<a href="{% url 'viajes.views.index' %}" class="btn default">
								Regresar
							</a>
							{% if form.fecha_ent.value %}
							<button type="submit" name="status" value="" class="btn blue" disabled >
								Guardar
							</button>	
							{% else %}
							<button type="submit" name="status" value="" class="btn blue"  >
								Guardar
							</button>	

							{% endif %}

						
						</div>
					</div>
				</div>
			</form>
			{% endblock %}

			{% block extra_script %}
			<script type="text/javascript" src="{{MEDIA_URL}}plugins/bootstrap-datepicker/js/bootstrap-datepicker.js"></script>
			<script type="text/javascript" src="{{MEDIA_URL}}plugins/select2/select2.js"></script>
			<script src="{{MEDIA_URL}}plugins/bootbox/bootbox.min.js" type="text/javascript"></script>
			<script src="{{MEDIA_URL}}scripts/jquery.number.min.js" type="text/javascript"></script>
			{% endblock %}

			{% block script_ready %}
////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////




$('.date-picker').datepicker({
rtl: Metronic.isRTL(),
orientation: "auto",
autoclose: true        
});

$("#id_destinos").select2({
    	placeholder: "Seleccionar destino",
    	multiple: true,
    	minimumInputLength: 2,
        ajax: {   
        	url: '{% url 'sepomex.views.direccion' %}',
        	dataType: 'json',
                data: function(term, page) {

                    return {
                        term: term
                    };
                },
                results: function(data, page) {
                    return {
                        results: data
                    };
            }
        },
		formatResult: sepomexFormatResult, // omitted for brevity, see the source of this page
        formatSelection: sepomexFormatSelection, // omitted for brevity, see the source of this page   	
	});
	

function sepomexFormatResult(municipio) {            
return municipio.municipio+', '+municipio.estado;
}

function sepomexFormatSelection(municipio) {
return municipio.municipio;
}

$('#id_cliente').select2();
$("#id_departamento").select2();     
$("#id_economico").select2();
$("#id_operador").select2();
$("#id_ruta").select2();
$("#id_tipo_ruta").select2();
$("#id_contiene").select2({    	
tags:["Equipo de comunicación", "Electrónica"],
maximumSelectionSize: 1        
});
$("#id_origen_clave_municipio").select2({
placeholder: "Seleccionar origen",
minimumInputLength: 2,
ajax: {   
url: '{% url 'sepomex.views.direccion' %}',
dataType: 'json',
data: function(term, page) {

return {
term: term
};
},
results: function(data, page) {
return {
results: data
};
}
},
initSelection: function(element, callback) {
var ids = $(element).val();	        
if (ids!=="") {
$.ajax("{% url 'sepomex.views.direccion_recupera_unico' %}", {
data: {
ids: ids
},
dataType: "json"
}).done(function(data) { callback(data); });
}
},
formatResult: sepomexFormatResult, // omitted for brevity, see the source of this page
formatSelection: sepomexFormatSelection, // omitted for brevity, see the source of this page   	
});    

$('#copyaddress').click(function(e){
e.preventDefault();
var cliente_id = $('#id_cliente').val();
if(cliente_id==''){
alert('Debe seleccionar un cliente');
}else{
$.ajax({
url: '{% url 'clientes.views.recoleccion' 99 %}'.replace('99', cliente_id),
dataType: 'json',
success: function(data){
$('#id_origen_cp').val(data.recoleccion_cp);
$("#id_origen_clave_municipio").select2("val", data.recoleccion_clave_municipio);
$('#id_origen_colonia').val(data.recoleccion_colonia);
$('#id_origen_calle').val(data.recoleccion_calle);
$('#id_origen_numero').val(data.recoleccion_numero);
}
});	
}		
});

$('.importe').change(function(){

calcular_total();
});

function calcular_total(){
var subtotal = 0;
var flete = parseFloat($('#id_facturacion_flete').val());
var desviacion = parseFloat($('#id_facturacion_desvio').val());
$('.importe').each(function(){
subtotal += parseFloat($(this).val());
});
iva = subtotal*.16;
//subtotal = importe+iva;
retencion = (flete+desviacion)*.04;
total = subtotal+iva-retencion;

//$('#importe').number( importe, 2 );
$('#iva').number( iva, 2 );
$('#subtotal').number( subtotal, 2 );
$('#retencion').number( retencion, 2 );
$('#total').number( total, 2 );
}
calcular_total();

$(".concepto").select2({    	
tags: {{conceptos|safe}},
maximumSelectionSize: 1        
});

//Formset gastos de salida
var index_salida = parseInt($('#id_salida-TOTAL_FORMS').val());
var max_salida = parseInt($('#id_salida-MAX_NUM_FORMS').val());

//Validar maximo de forms
$('#btn_add_salida').live("click", function(e){	

e.preventDefault();
if(index_salida < max_salida){					

$("#id_salida-0-concepto").select2("destroy");

$('#salida_table').append(
$('#salida_table .tr_form_ap:first')
.clone(false, true)
.find('input[name="salida-0-id"]')
.attr('id','id_salida-'+index_salida+'-id')
.attr('name', 'salida-'+index_salida+'-id')
.val('')
.end()
.find('input[name="salida-0-tipo"]')
.attr('id','id_salida-'+index_salida+'-tipo')
.attr('name', 'salida-'+index_salida+'-tipo')
.val('1')
.end()
.find('input[name="salida-0-viaje"]')
.attr('id','id_salida-'+index_salida+'-viaje')
.attr('name', 'salida-'+index_salida+'-viaje')				
.end()
.find('input[name="salida-0-concepto"]')
.attr('id','id_salida-'+index_salida+'-concepto')
.attr('name', 'salida-'+index_salida+'-concepto')
.val('')
.end()
.find('input[name="salida-0-comentarios"]')
.attr('id','id_salida-'+index_salida+'-comentarios')
.attr('name', 'salida-'+index_salida+'-comentarios')
.val('')
.end()
.find('.calculado')
.html('')
.end()
.find('input[name="salida-0-pagado_operaciones"]')
.attr('id','id_salida-'+index_salida+'-pagado_operaciones')
.attr('name', 'salida-'+index_salida+'-pagado_operaciones')
.val('')			
.end()
.find('input[name="salida-0-pagado_contabilidad"]')
.attr('id','id_salida-'+index_salida+'-pagado_contabilidad')
.attr('name', 'salida-'+index_salida+'-pagado_contabilidad')
.val('')
.end()
.find('input[name="salida-0-DELETE"]')
.attr('id','id_salida-'+index_salida+'-DELETE')
.attr('name', 'salida-'+index_salida+'-DELETE')
.attr('checked', false)
.end()			
);

$("#id_salida-0-concepto").select2({    	
tags: {{conceptos|safe}},
maximumSelectionSize: 1        
});
$("#id_salida-"+index_salida+"-concepto").select2({    	
tags: {{conceptos|safe}},
maximumSelectionSize: 1        
});

index_salida++;
$('#id_salida-TOTAL_FORMS').val(index_salida);
}else{
alert('No se pueden agregar mas gastos');								
}		
});




//Formset gastos de regreso //////////////////////////////////////////////////////
var index_regreso = parseInt($('#id_regreso-TOTAL_FORMS').val());
var max_regreso = parseInt($('#id_regreso-MAX_NUM_FORMS').val());

//Validar maximo de forms
$('#btn_add_regreso').live("click", function(e){	

e.preventDefault();

if(index_regreso < max_regreso){

$("#id_regreso-0-concepto").select2("destroy");

$('#regreso_table').append(
$('#regreso_table .tr_form_ap:first')	
.clone(false, true).find('input[name="regreso-0-id"]')
.attr('id','id_regreso-'+index_salida+'-id')
.attr('name', 'regreso-'+index_salida+'-id')
.val('')
.end()
.find('input[name="regreso-0-concepto"]')
.attr('id','id_regreso-'+index_regreso+'-concepto')
.attr('name', 'regreso-'+index_regreso+'-concepto')
.val('')
.end()
.find('input[name="regreso-0-comentarios"]')
.attr('id','id_regreso-'+index_regreso+'-comentarios')
.attr('name', 'regreso-'+index_regreso+'-comentarios')
.val('')
.end()
.find('input[name="regreso-0-importe"]')
.attr('id','id_regreso-'+index_regreso+'-importe')
.attr('name', 'regreso-'+index_regreso+'-importe')
.val('')			
.end()
.find('input[name="regreso-0-idPartida"]')
.attr('id','id_regreso-'+index_regreso+'-idPartida')
.attr('name', 'regreso-'+index_regreso+'-idPartida')
.val('')
.end()
.find('input[name="regreso-0-idArea"]')
.attr('id','id_regreso-'+index_regreso+'-idArea')
.attr('name', 'regreso-'+index_regreso+'-idArea')
.val('')
.end()
.find('input[name="regreso-0-DELETE"]')
.attr('id','id_regreso-'+index_regreso+'-DELETE')
.attr('name', 'regreso-'+index_regreso+'-DELETE')
.attr('checked', false)
.end()			
);

$("#id_regreso-0-concepto").select2({    	
tags: {{conceptos|safe}},
maximumSelectionSize: 1        
});
$("#id_regreso-"+index_regreso+"-concepto").select2({    	
tags: {{conceptos|safe}},
maximumSelectionSize: 1        
});

index_regreso++;
$('#id_regreso-TOTAL_FORMS').val(index_regreso);
}else{
alert('No se pueden agregar mas gastos de regreso');								
}

});

$('.delete').live("click", function(){		
$(this).siblings('input').val(1);
$(this).parent().parent().slideUp('slow');
});

$('#statusform').submit(function(event){									
$('#salida_table tbody tr').each(function(){
var concepto = $(this).find('input[id$=concepto]').val();
if(concepto == ''){
$(this).find('input[id$=tipo]').val('');
$(this).find('input[id$=viaje]').val('');
}
});

$('#regreso_table tbody tr').each(function(){
var concepto = $(this).find('input[id$=concepto]').val();
if(concepto == ''){
$(this).find('input[id$=tipo]').val('');
$(this).find('input[id$=viaje]').val('');
}
});
});






{% endblock %}
