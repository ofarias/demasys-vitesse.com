{% extends 'base.html' %}
{% load i18n humanize %}
{% load sepomex_filters %}
{% load url from future %}

{% block title %}Viajes{% endblock %}
{% block content_title %} Viaje {{viaje}} - {{current.state}}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" type="text/css" href="{{MEDIA_URL}}plugins/bootstrap-datepicker/css/datepicker3.css"/>
<link rel="stylesheet" type="text/css" href="{{MEDIA_URL}}plugins/select2/select2.css"/>
{% endblock %}

{% block nav-viajes %}<li class="active">{% endblock %}

{% block breadcrumb %}
<ul class="page-breadcrumb">
	<li>
		<i class="fa fa-home"></i>
		<a href="{% url 'dashboards.views.index' %}">Dashboard</a>	
		<i class="fa fa-angle-right"></i>					
	</li>
	<li>		
		<a href="{% url 'viajes.views.index' %}">Viajes</a>		
		<i class="fa fa-angle-right"></i>				
	</li>	
	<li>		
		<a href="#">Carta {{viaje}}</a>							
	</li>	
</ul>
{% endblock %}

{% block actions %}
{% endblock %}

{% block content %}
<form action="{% url 'viajes.views.facturado' viaje.pk %}" class="form-horizontal form-row-seperated" method="post" id="statusform">
						{% csrf_token %}
<div class="row">
            <div class="col-md-12">
        		<div class="portlet-body form">					
						<div class="form-body">							
							<h3 class="form-section">Datos Generales</h3>
							<div class="row">
								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label col-md-3">Carta porte:</label>
										<div class="col-md-9">
											<p class="form-control-static">
												 {{viaje}}
											</p>
										</div>
									</div>
								</div>
								<!--/span-->
								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label col-md-3">Fecha de salida:</label>
										<div class="col-md-9">
											<p class="form-control-static">
												 {{viaje.fecha_salida|date:"d-m-Y"}}
											</p>
										</div>
									</div>
								</div>
								<!--/span-->
							</div>
							<div class="row">
								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label col-md-3">Cliente:</label>
										<div class="col-md-9">
											<p class="form-control-static">
												 {{viaje.cliente}}
											</p>
										</div>
									</div>
								</div>
								<!--/span-->
								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label col-md-3">Departamento:</label>
										<div class="col-md-9">
											<p class="form-control-static">
												 {{viaje.departamento}}
											</p>
										</div>
									</div>
								</div>
								<!--/span-->
							</div>
							<div class="row">
								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label col-md-3">Bill/Load:</label>
										<div class="col-md-9">
											<p class="form-control-static">
												 {{viaje.referencia}}
											</p>
										</div>
									</div>
								</div>
								<!--/span-->
								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label col-md-3">Operador:</label>
										<div class="col-md-9">
											<p class="form-control-static">
												 {{viaje.operador}}
											</p>
										</div>
									</div>
								</div>
								<!--/span-->
							</div>
							<div class="row">
								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label col-md-3">Economico:</label>
										<div class="col-md-9">
											<p class="form-control-static">
												 {{viaje.economico}}
											</p>
										</div>
									</div>
								</div>
								<!--/span-->
								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label col-md-3">Ruta:</label>
										<div class="col-md-9">
											<p class="form-control-static">
												 {{viaje.ruta}}
											</p>
										</div>
									</div>
								</div>
								<!--/span-->
							</div>
							<div class="row">
								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label col-md-3">Contenido:</label>
										<div class="col-md-9">
											<p class="form-control-static">
												 {{viaje.contiene}}
											</p>
										</div>
									</div>
								</div>
							</div>

							<h3 class="form-section">Origen</h3>
							<div class="row">
								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label col-md-3">Municipio:</label>
										<div class="col-md-9">
											<p class="form-control-static">
												 {{viaje.origen_clave_municipio|municipio}}
											</p>
										</div>
									</div>
								</div>
								<!--/span-->
								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label col-md-3">Colonia:</label>
										<div class="col-md-9">
											<p class="form-control-static">
												 {{viaje.origen_colonia}}
											</p>
										</div>
									</div>
								</div>
								<!--/span-->
							</div>
							<div class="row">
								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label col-md-3">Calle:</label>
										<div class="col-md-9">
											<p class="form-control-static">
												 {{viaje.origen_calle}} No. {{viaje.origen_numero}}
											</p>
										</div>
									</div>
								</div>
								<!--/span-->
								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label col-md-3">CP:</label>
										<div class="col-md-9">
											<p class="form-control-static">
												 {{viaje.origen_cp}}
											</p>
										</div>
									</div>
								</div>
								<!--/span-->
							</div>						
							<h3 class="form-section">Destino(s)</h3>
							{% for destino in viaje.destino_set.all %}
							<div class="row">								
								<div class="col-md-4">
									<div class="form-group">
										<label class="control-label col-md-3">Destino:</label>										
										<div class="col-md-9">
											<p class="form-control-static">												
												{{destino.destino_clave_municipio|municipio}}										
											</p>
										</div>										
									</div>
								</div>
								<div class="col-md-4">
									<div class="form-group">
										<label class="control-label col-md-3">Fecha de entrega:</label>										
										<div class="col-md-9">
											<p class="form-control-static">												
												{{destino.fecha_entrega|date:"d-m-Y"}}										
											</p>
										</div>										
									</div>
								</div>
								<div class="col-md-4">
									<div class="form-group">
										<label class="control-label col-md-3">Comprobante: &nbsp;</label>										
										<div class="col-md-9">												
											<p class="form-control-static">												
												{% if destino.comprobante_entrega %}									
												<a href="{{destino.comprobante_entrega.url}}">Descargar</a>
												{% endif %}											
											</p>																																																		
										</div>										
									</div>
								</div>
							</div>
							{% endfor %}
							<h3 class="form-section">Observaciones</h3>
							<div class="form-group {% if form.observaciones.errors %}has-error{% endif %}">
								<label class="control-label col-md-3">Observaciones</label>
								<div class="col-md-9">
									{{form.observaciones}}
									{% if form.observaciones.errors %}<span class="help-block">{{form.observaciones.errors}}</span>{% endif %}													
								</div>
							</div>	
							<h3 class="form-section">Facturación</h3>	
							<div class="row">
								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label col-md-3">No. de Factura:  <span class="required" aria-required="true"> * </span></label>
										<div class="col-md-9">											
												 {{form.factura}}
												 {% if form.factura.errors %}<span class="help-block">{{form.factura.errors}}</span>{% endif %}											
										</div>
									</div>
								</div>
								<!--/span-->
								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label col-md-3">Forma de pago:  <span class="required" aria-required="true"> * </span></label>
										<div class="col-md-9">											
												 {{form.facturacion_forma_pago}}
												 {% if form.facturacion_forma_pago.errors %}<span class="help-block">{{form.facturacion_forma_pago.errors}}</span>{% endif %}											
										</div>
									</div>
								</div>
								<!--/span-->
							</div>	
							<div class="row">
								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label col-md-3">Banco:  <span class="required" aria-required="true"> * </span></label>
										<div class="col-md-9">											
												 {{form.facturacion_banco}}
												 {% if form.facturacion_banco.errors %}<span class="help-block">{{form.facturacion_banco.errors}}</span>{% endif %}											
										</div>
									</div>
								</div>
								<!--/span-->
								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label col-md-3">Documento:  <span class="required" aria-required="true"> * </span></label>
										<div class="col-md-9">											
												 {{form.facturacion_documento}}
												 {% if form.facturacion_documento.errors %}<span class="help-block">{{form.facturacion_documento.errors}}</span>{% endif %}											
										</div>
									</div>
								</div>
								<!--/span-->
							</div>	
							<div class="row">
								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label col-md-3">Flete: <span class="required" aria-required="true"> * </span></label>
										<div class="col-md-9">											
												 {{form.facturacion_flete}}
												 {% if form.facturacion_flete.errors %}<span class="help-block">{{form.facturacion_flete.errors}}</span>{% endif %}											
										</div>
									</div>
								</div>
								<!--/span-->
								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label col-md-3">Casetas:</label>
										<div class="col-md-9">
												{{form.facturacion_casetas}}
												{% if form.facturacion_casetas.errors %}<span class="help-block">{{form.facturacion_casetas.errors}}</span>{% endif %}
										</div>
									</div>
								</div>
								<!--/span-->
							</div>	
							<div class="row">
								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label col-md-3">Maniobra:</label>
										<div class="col-md-9">
												{{form.facturacion_maniobra}}
												{% if form.facturacion_maniobra.errors %}<span class="help-block">{{form.facturacion_maniobra.errors}}</span>{% endif %}
										</div>
									</div>									
								</div>
								<!--/span-->
								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label col-md-3">Reparto: </label>
										<div class="col-md-9">											
												 {{form.facturacion_reparto}}
												 {% if form.facturacion_reparto.errors %}<span class="help-block">{{form.facturacion_reparto.errors}}</span>{% endif %}											
										</div>
									</div>									
								</div>
								<!--/span-->
							</div>
							<div class="row">
								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label col-md-3">Desvio:</label>
										<div class="col-md-9">
												{{form.facturacion_desvio}}
												{% if form.facturacion_desvio.errors %}<span class="help-block">{{form.facturacion_desvio.errors}}</span>{% endif %}
										</div>
									</div>									
								</div>
								<!--/span-->
								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label col-md-3">Ferri: </label>
										<div class="col-md-9">											
												 {{form.facturacion_ferri}}
												 {% if form.facturacion_ferri.errors %}<span class="help-block">{{form.facturacion_ferri.errors}}</span>{% endif %}											
										</div>
									</div>									
								</div>
								<!--/span-->
							</div>	
							<div class="row">
								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label col-md-3">Otros:</label>
										<div class="col-md-9">
												{{form.facturacion_otros}}
												{% if form.facturacion_otros.errors %}<span class="help-block">{{form.facturacion_otros.errors}}</span>{% endif %}
										</div>
									</div>									
								</div>
								<!--/span-->
								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label col-md-3"></label>
										<div class="col-md-9">											
												 										
										</div>
									</div>
								</div>								
								<!--/span-->
							</div>	
							<div class="row">
								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label col-md-3">Subtotal: </label>
										<div class="col-md-9">											
												 <p class="form-control-static">
													<span id="subtotal"></span>
												</p>											
										</div>
									</div>
								</div>
								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label col-md-3"></label>
										<div class="col-md-9">											
												 										
										</div>
									</div>
								</div>
							</div>
							<div class="row">
								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label col-md-3">IVA:</label>
										<div class="col-md-9">
												<p class="form-control-static">
													<span id="iva"></span>
												</p>
										</div>
									</div>
								</div>
								<!--/span-->
								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label col-md-3"></label>
										<div class="col-md-9">											
												 										
										</div>
									</div>
								</div>								
								<!--/span-->
							</div>	
							<div class="row">
								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label col-md-3">Retención:</label>
										<div class="col-md-9">
												<p class="form-control-static">
													<span id="retencion"></span>
												</p>
										</div>
									</div>
								</div>
								<!--/span-->
								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label col-md-3"></label>
										<div class="col-md-9">											
												 										
										</div>
									</div>
								</div>								
								<!--/span-->
							</div>		
							<div class="row">								
								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label col-md-3">Total: </label>
										<div class="col-md-9">											
												 <p class="form-control-static">
													<span id="total"></span>
												</p>											
										</div>
									</div>
								</div>
								<!--/span-->
								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label col-md-3">&nbsp;</label>
										<div class="col-md-9">
												&nbsp;
										</div>
									</div>
								</div>
								<!--/span-->
							</div>								
				</div>
			</div>
		</div>	
	</div>
	<div class="row">		
		<div class="col-md-12">
			<div class="portlet light form-fit">				
				<div class="portlet-body form">
					<h3 class="form-section">Gastos de Salida</h3>
					<div class="table-toolbar">
						<div class="row">
							<div class="col-md-6">
								<div class="btn-group">
									<button id="btn_add_salida" class="btn green">
									Agregar Gasto Salida<i class="fa fa-plus"></i>
									</button>
								</div>
							</div>
							<div class="col-md-6">								
							</div>
						</div>
					</div>		
					<div class="table-responsive">	
					<table class="table table-striped table-hover table-bordered" id="salida_table">
							<thead>
							<tr>
								<th>
									 Concepto
								</th>
								<th>
									 Comentarios
								</th>
								<th>
									 Calculado
								</th>
								<th>
									 Pagado por Operaciones
								</th>
								<th>
									 Pagado por Contabilidad
								</th>
								<th>
									<strong>Total Pagado</strong>
								</th>
								<th>
									 Comprobantes
								</th>
							</tr>
							</thead>
							<tbody>
							{% for gasto in viaje.gastos_salida %}
							<tr class="tr_form_ap">
								<td>
									{{gasto.concepto}}
								</td>
								<td>
									{{gasto.comentarios}}									 
								</td>
								<td class="text-right">
									{{gasto.calculado|default_if_none:"0"}}									
								</td>
								<td class="text-right">
									{{gasto.pagado_operaciones|default_if_none:"0"}}
								</td>
								<td class="text-right">
									{{gasto.pagado_contabilidad|default_if_none:"0"}}
								</td>
								<td class="text-right">
									{{gasto.total_pagado}}
								</td>
								<td>
									<a href="{% url 'viajes.views.comprobantegasto' gasto.pk %}" class="btn btn-sm blue">
																<i class="fa fa-file-o"></i> Consultar/Cargar </a>
								</td>
							</tr>	
							{% endfor %}						
						</tbody>
					</table>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="row">		
		<div class="col-md-12">
			<div class="portlet light form-fit">				
				<div class="portlet-body form">					
					<h3 class="form-section">Gastos de Regreso</h3>
					<div class="table-toolbar">
						<div class="row">
							<div class="col-md-6">
								<div class="btn-group">
									<button id="btn_add_regreso" class="btn green">
									Agregar Gasto de Regreso<i class="fa fa-plus"></i>
									</button>
								</div>
							</div>
							<div class="col-md-6">								
							</div>
						</div>
					</div>	
					<div class="table-responsive">		
					<table class="table table-striped table-hover table-bordered" id="regreso_table">
							<thead>
							<tr>
								<th>
									 Concepto
								</th>
								<th>
									 Comentarios
								</th>
								<th>
									 Calculado
								</th>
								<th>
									 Pagado por Operaciones
								</th>
								<th>
									 Pagado por Contabilidad
								</th>
								<th>
									<strong>Total Pagado</strong>
								</th>
								<th>
									 Comprobantes
								</th>
							</tr>
							</thead>
							<tbody>
							{% for gasto in viaje.gastos_regreso %}
							<tr class="tr_form_ap">
								<td>
									{{gasto.concepto}}
								</td>
								<td>
									{{gasto.comentarios}}									 
								</td>
								<td class="text-right">
									{{gasto.calculado|default_if_none:"0"}}									
								</td>
								<td class="text-right">
									{{gasto.pagado_operaciones|default_if_none:"0"}}
								</td>
								<td class="text-right">
									{{gasto.pagado_contabilidad|default_if_none:"0"}}
								</td>
								<td class="text-right">
									{{gasto.total_pagado}}
								</td>
								<td>
									<a href="{% url 'viajes.views.comprobantegasto' gasto.pk %}" class="btn btn-sm blue">
																<i class="fa fa-file-o"></i> Consultar/Cargar </a>
								</td>
							</tr>	
							{% endfor %}								
						</tbody>
					</table>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="form-actions">
		<div class="row">
			<div class="col-md-offset-3 col-md-9">
				{{form.status}}
				{{form.nota}}
				<a href="{% url 'viajes.views.index' %}" class="btn default">
								Regresar
				</a>
				{% for transicion in transiciones %}
				<button type="submit" name="status" value="{{transicion.pk}}" class="btn {% if transicion.name == 'Cancelar' %}red{% else %}blue{% endif %}" data-status="{{transicion.pk}}" data-name="{{transicion.name}}">
					 {{transicion.name}}
				</button>
				{% endfor %}
				<button type="submit" name="status" value="0" class="btn blue" data-status="0">Guardar</button>
			</div>
		</div>
	</div>
	</form>
{% endblock %}

{% block extra_script %}
<script type="text/javascript" src="{{MEDIA_URL}}plugins/bootstrap-datepicker/js/bootstrap-datepicker.js"></script>
<script type="text/javascript" src="{{MEDIA_URL}}plugins/select2/select2.js"></script>
<script src="{{MEDIA_URL}}plugins/bootbox/bootbox.min.js" type="text/javascript"></script>
<script src="{{MEDIA_URL}}scripts/jquery.number.min.js" type="text/javascript"></script>
{% endblock %}

<script type="text/javascript">
{% block script_ready %}
		
	var status = '';
	var name = '';
	$("form button[type=submit]").click(function() {	    
	    status = $(this).data("status");
	    name = $(this).data("name");
	    $('#id_status').val(status);
	});
	
	$('#statusform').submit(function(event){		
		event.preventDefault();	
		var myform = this;				
				
		if(name == 'Cancelar'){
			bootbox.prompt("¿Cual es el motivo de la cancelación?", function(result) {
           		if (result === null) {
					alert('Para cancelar, debe especificar el motivo');
				}else{
					if(result!=''){
						$('#id_nota').val(result);
						myform.submit();	
					}else{
						alert('Para cancelar, debe especificar el motivo');
					}				
				}
			});
		}else{
			myform.submit();
		}		
	});
	
	$('.importe').change(function(){
		
		calcular_total();
	});
	
	function calcular_total(){
		var subtotal = 0;
		var flete = parseFloat($('#id_facturacion_flete').val());
		var desviacion = parseFloat($('#id_facturacion_desvio').val());
		$('.importe').each(function(){
		    subtotal += parseFloat($(this).val());
		});
		iva = subtotal*.16;
		//subtotal = importe+iva;
		retencion = (flete+desviacion)*.04;
		total = subtotal+iva-retencion;
		
		//$('#importe').number( importe, 2 );
		$('#iva').number( iva, 2 );
		$('#subtotal').number( subtotal, 2 );
		$('#retencion').number( retencion, 2 );
		$('#total').number( total, 2 );
	}
	calcular_total();
			
{% endblock %}
</script>